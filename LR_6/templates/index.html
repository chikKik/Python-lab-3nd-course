<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Tracker - Observer Pattern Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .client-id {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .currency-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .currency-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .currency-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .currency-btn.active {
            background: #4CAF50;
            color: white;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .currency-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .currency-card.updated {
            animation: highlight 1s ease;
        }
        
        @keyframes highlight {
            0% { background: rgba(76, 175, 80, 0.3); }
            100% { background: rgba(255, 255, 255, 0.95); }
        }
        
        .currency-code {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        
        .currency-name {
            color: #666;
            margin-bottom: 10px;
        }
        
        .currency-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
        }
        
        .currency-nominal {
            color: #888;
            font-size: 0.9em;
        }
        
        .last-updated {
            color: #999;
            font-size: 0.8em;
            margin-top: 10px;
        }
        
        .status {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .status-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-connected {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .status-disconnected {
            color: #f44336;
            font-weight: bold;
        }
        
        .log {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .message {
            color: #333;
        }
        
        .update {
            color: #4CAF50;
        }
        
        .error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Currency Tracker</h1>
            <p class="subtitle">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å" —Å WebSocket</p>
            <p>ID –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è: <span id="observerId" class="client-id">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        </div>
        
        
        <div class="dashboard" id="currencyDashboard">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –≤–∞–ª—é—Ç –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        
        <div class="status">
            <h2>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
            <div class="status-item">
                WebSocket: <span id="wsStatus" class="status-disconnected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
            </div>
            <div class="status-item">
                –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="lastUpdate">–ù–∏–∫–æ–≥–¥–∞</span>
            </div>
        </div>
        
        <div class="log">
            <h2>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h2>
            <div id="eventLog">
                <!-- –°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º SocketIO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let socket = null;
        let observerId = null;
        let selectedCurrencies = new Set(['USD', 'EUR', 'GBP']);
        let trackedCurrencies = new Set();
        let currencyData = {};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function initWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateStatus('connected');
                logEvent('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'update');
            });
            
            socket.on('connected', function(data) {
                observerId = data.observer_id;
                document.getElementById('observerId').textContent = observerId;
                logEvent(`ID –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è: ${observerId}`, 'update');
            });
            
            socket.on('currency_update', function(data) {
                updateLastUpdate();
                logEvent(`–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤: ${Object.keys(data.currencies).join(', ')}`, 'update');
                updateCurrencyDisplay(data.currencies);
            });
            
            socket.on('tracking_started', function(data) {
                trackedCurrencies = new Set(data.currencies);
                updateTrackedCount();
                logEvent(`–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ: ${data.currencies.join(', ')}`, 'update');
            });
            
            socket.on('disconnect', function() {
                updateStatus('disconnected');
                logEvent('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞–ª—é—Ç
        async function loadAvailableCurrencies() {
            try {
                const response = await fetch('/api/currencies');
                const currencies = await response.json();
        
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                currencyData = currencies;
        
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Å–µ –≤–∞–ª—é—Ç—ã
                if (socket && socket.connected) {
                    socket.emit('track_currency', {
                        currencies: Object.keys(currencies)
                    });
                }
        
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                updateCurrencyDisplay(currencies);
        
            } catch (error) {
                logEvent(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–ª—é—Ç: ${error.message}`, 'error');
            }
        }

        
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
        function updateCurrencyDisplay(currencies) {
            const dashboard = document.getElementById('currencyDashboard');
            
            Object.entries(currencies).forEach(([code, data]) => {
                let card = document.getElementById(`card-${code}`);
                
                if (!card) {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    card = document.createElement('div');
                    card.className = 'currency-card';
                    card.id = `card-${code}`;
                    
                    card.innerHTML = `
                        <div class="currency-code">${code}</div>
                        <div class="currency-name">${data.name}</div>
                        <div class="currency-value">${data.value.toFixed(4)} ‚ÇΩ</div>
                        <div class="currency-nominal">–ù–æ–º–∏–Ω–∞–ª: ${data.nominal}</div>
                        <div class="last-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(data.last_updated).toLocaleTimeString()}</div>
                    `;
                    
                    dashboard.appendChild(card);
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    card.querySelector('.currency-value').textContent = `${data.value.toFixed(4)} ‚ÇΩ`;
                    card.querySelector('.last-updated').textContent = 
                        `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(data.last_updated).toLocaleTimeString()}`;
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    card.classList.add('updated');
                    setTimeout(() => card.classList.remove('updated'), 1000);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                currencyData[code] = data;
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateStatus(status) {
            const statusElement = document.getElementById('wsStatus');
            if (status === 'connected') {
                statusElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                statusElement.className = 'status-connected';
            } else {
                statusElement.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                statusElement.className = 'status-disconnected';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –≤–∞–ª—é—Ç
        function updateTrackedCount() {
            document.getElementById('trackedCount').textContent = trackedCurrencies.size;
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
        function logEvent(message, type = 'message') {
            const log = document.getElementById('eventLog');
            const item = document.createElement('div');
            item.className = 'log-item';
            
            const timestamp = new Date().toLocaleTimeString();
            item.innerHTML = `<span class="timestamp">${timestamp}</span>
                             <span class="message ${type}">${message}</span>`;
            
            log.prepend(item);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            if (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            initWebSocket();
            loadAvailableCurrencies();
            logEvent('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'update');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(trackSelectedCurrencies, 2000);
        };
    </script>
</body>
</html>